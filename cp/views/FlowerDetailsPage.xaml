<Page x:Class="cp.views.FlowerDetailsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:cp.views"
      xmlns:vms="clr-namespace:cp.viewModels" xmlns:helpers="clr-namespace:cp.helpers"
      mc:Ignorable="d" 
      d:DesignHeight="450" d:DesignWidth="800"
      Title="{DynamicResource FlowerDetailsPage_Title}">

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <helpers:ReviewDeleteVisibilityConverter x:Key="ReviewDeleteVisibilityConverter"/>
    </Page.Resources>


    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Background="#FAFAFA" Margin="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Row="0" Grid.Column="0" BorderBrush="#CCC" BorderThickness="1" Margin="10">
                <Image Source="{Binding ImageURL}" Width="250" Height="250" Stretch="UniformToFill"/>
            </Border>

            <StackPanel Grid.Row="0" Grid.Column="1" Margin="20">
                <TextBlock Text="{Binding Name}" FontSize="28" FontWeight="Bold" Foreground="#333"/>
                <TextBlock Text="{Binding Price, StringFormat=' {0:C}'}" FontSize="20" Foreground="#666" Margin="0,10,0,0"/>
                <TextBlock Text="{Binding Description}" TextWrapping="Wrap" FontSize="14" Foreground="#444"/>
               <Button Content="Добавить в корзину"
        Command="{Binding AddToCartCommand}"
        CommandParameter="{Binding CurrentFlower}"
        Visibility="{Binding IsUser, Converter={StaticResource BoolToVis}}" />

            </StackPanel>

            <StackPanel Grid.Row="1" Grid.ColumnSpan="2" Margin="10,30,10,0" Width="Auto">
                <TextBlock Text="{DynamicResource LeaveReviewLabel}" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>

                <Grid Margin="0,0,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="150"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="{DynamicResource ReviewTitleLabel}" Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Margin="0,5"/>
                    <TextBox Text="{Binding ReviewTitle, Mode=TwoWay}" Grid.Row="0" Grid.Column="1" Margin="5" IsEnabled="{Binding IsUserAuthenticated}"/>

                    <TextBlock Text="{DynamicResource ReviewContentLabel}" Grid.Row="1" Grid.Column="0" VerticalAlignment="Top" Margin="0,5"/>
                    <TextBox Text="{Binding ReviewContent, Mode=TwoWay}" Grid.Row="1" Grid.Column="1" Margin="5" AcceptsReturn="True" Height="80" IsEnabled="{Binding IsUserAuthenticated}"/>

                    <TextBlock Text="{DynamicResource ReviewScoreLabel}" Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" Margin="0,5"/>
                    <TextBox Text="{Binding ReviewScore, Mode=TwoWay}" Grid.Row="2" Grid.Column="1" Margin="5" IsEnabled="{Binding IsUserAuthenticated}"/>
                </Grid>

                <Button Content="{DynamicResource Btn_SubmitReview}" Command="{Binding SubmitReviewCommand}" HorizontalAlignment="Left" Padding="10,5" IsEnabled="{Binding IsUserAuthenticated}"/>
            </StackPanel>

            <Separator Grid.Row="2" Grid.ColumnSpan="2" Margin="0,10"/>

            <StackPanel Grid.Row="3" Grid.ColumnSpan="2" Margin="0,10,0,0">
                <TextBlock Text="{DynamicResource ReviewsLabel}" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>

                <ItemsControl ItemsSource="{Binding Reviews}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border BorderBrush="#CCC" BorderThickness="1" Margin="0,5" Padding="10" Background="White">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                                        <TextBlock Text="{Binding Title}" FontWeight="Bold" FontSize="14"/>
                                        <TextBlock Text="{Binding User.FullName}" Foreground="#888" Margin="10,0,0,0" FontSize="12"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding Content}" TextWrapping="Wrap" Margin="0,5,0,0"/>
                                    <TextBlock Text="{Binding Score, StringFormat=Оценка: {0}}" Foreground="#888" FontSize="12"/>

                                    <Button Content="{DynamicResource Btn_DeleteReview}"
        Command="{Binding DataContext.DeleteReviewCommand, RelativeSource={RelativeSource AncestorType=Page}}"
        CommandParameter="{Binding}"
        Margin="0,5,0,0"
        HorizontalAlignment="Right">
                                        <Button.Visibility>
                                            <MultiBinding Converter="{StaticResource ReviewDeleteVisibilityConverter}">
                                                <Binding Path="DataContext.AuthenticatedUser" RelativeSource="{RelativeSource AncestorType=Page}" />
                                                <Binding Path="UserId"/>
                                                <Binding Path="DataContext.IsAdmin" RelativeSource="{RelativeSource AncestorType=Page}" />
                                            </MultiBinding>
                                        </Button.Visibility>
                                    </Button>

                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</Page>
